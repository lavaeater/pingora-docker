services:
  webhook:
    build:
      context: ./webhooks
      dockerfile: Dockerfile
    container_name: webhook
    command: -verbose -hooks=/config/hooks.json -hotreload -template
    environment:
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
      - INIT_SERVICES=${INIT_SERVICES:-false}
      - BUILD_ON_INIT=${BUILD_ON_INIT:-false}
    volumes:
      - ./webhooks/hooks.json:/config/hooks.json:ro
      - ./webhooks/services.json:/config/services.json:ro
      - ./webhooks/rebuild.sh:/scripts/rebuild.sh:ro
      - ./webhooks/init-services.sh:/scripts/init-services.sh:ro
      - ./repos:/repos
      - ./repos:/compose/repos
      - ./docker-compose.yml:/compose/docker-compose.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.ssh/id_ed25519:/ssh-keys/id_ed25519:ro
      - ~/.ssh/known_hosts:/ssh-keys/known_hosts:ro
    ports:
      - "9000:9000"
    restart: unless-stopped
    networks:
      - proxy-network

  pingora:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pingora
    volumes:
      - ./config.json:/usr/src/pingora/config.json:ro
      - ./certs:/certs
    ports:
      - "8443:8443"
    environment:
      - RUST_LOG=debug
    restart: unless-stopped
    networks:
      - proxy-network

  jellyfin:
    image: jellyfin/jellyfin
    container_name: jellyfin
    ports:
      - 8096:8096/tcp
      - 7359:7359/udp
    volumes:
      - /home/tommie/projects/jellyfin/config:/config
      - /home/tommie/projects/jellyfin/cache:/cache
      - type: bind
        source: /media/brontosaurus/media
        target: /media
    restart: unless-stopped
    networks:
      - proxy-network
    
  sickgear:
    container_name: sickgear
    image: sickgear/sickgear:latest
    environment:
      - APP_UID=1000
      - APP_GID=1000
      - TZ=UTC
    ports:
      - 8081:8081/tcp
    volumes:
      - /home/tommie/projects/jellyfin/data:/data
      - /home/tommie/Downloads/deluge/finished/tv:/incoming
      - /media/brontosaurus/media/tv:/tv
    restart: unless-stopped
    networks:
      - proxy-network

  rusty-budgets:
    build:
      context: ./repos/rusty-budgets
      dockerfile: Dockerfile
    container_name: rusty-budgets
    environment:
      - DATA_FILE=/data.json
    ports:
      - 8666:8666/tcp
    volumes:
      - /home/tommie/projects/rusty-budgets/data.json:/data.json
    restart: unless-stopped
    networks:
      - proxy-network
      
  oxidize-books:
    build:
      context: ./repos/oxidize-books
      dockerfile: Dockerfile
    container_name: oxidize-books
    environment:
      DATABASE_URL: postgresql://postgres:birkobengo@postgres/oxidized_books
      OXIDIZED_BOOKS_INPUT_PATH: /books_input
      OXIDIZED_BOOKS_BOOK_PATH: /books
      OXIDIZED_TEMP_PATH: /book_temp
    ports:
      - 8888:8888/tcp
    volumes:
      - /home/tommie/Downloads/deluge/finished/books/:/books_input
      - /media/brontosaurus/media/books/:/books
      - /home/tommie/Downloads/book_temp/:/book_temp
    restart: unless-stopped
    networks:
      - proxy-network
  
  postgres:
    # Official Postgres image from DockerHub (we use the last version)
    image: "postgres:latest"
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: postgres # The PostgreSQL user (useful to connect to the database)
      POSTGRES_PASSWORD: birkobengo # The PostgreSQL password (useful to connect to the database)
      POSTGRES_DB: oxidized_books # The PostgreSQL default database (automatically created at first launch)
    # The `volumes` tag allows us to share a folder with our container.
    # Its syntax is as follows: [folder path on our machine]:[folder path to retrieve in the containqer]
    volumes:
      - /home/tommie/Books/oxidized_books/:/var/lib/postgresql/
    restart: unless-stopped
    networks:
      - proxy-network
        
  deluge:
    image: lscr.io/linuxserver/deluge:latest
    container_name: deluge
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Stockholm
      - DELUGE_LOGLEVEL=error #optional
    volumes:
      - /home/tommie/projects/pingora-docker/deluge-config:/config
      - /home/tommie/Downloads/deluge:/home/tommie/Downloads/deluge
      - /media/brontosaurus/media:/media/brontosaurus/media
    ports:
      - 8112:8112
      - 6881:6881
      - 6881:6881/udp
      - 58846:58846 #optional
    restart: unless-stopped

networks:
  proxy-network:
    ipam:
      config:
        - subnet: 172.24.0.0/16
    driver: bridge
    name: proxy-network